<!DOCTYPE html>
<html lang="zh_cn">
<head>
    <meta charset="UTF-8">
    <title>熊熊地图补全计划</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
</head>
<style>
    .break-all {
        white-space: nowrap;
        overflow: auto;
        max-width: 300px;
    }
</style>
<body>
    <div class="container">
        <h1 class="text-center my-4">补全专用网页</h1>
        <div class="form-group mb-3">
            <label for="map_name">地图名称</label>
            <input class="form-control mb-1" placeholder="地图名称" id="map_name"/>
            <label for="map_url">地图链接</label>
            <input class="form-control mb-1" placeholder="地图链接" id="map_url"/>
            <label for="url_code">提取码</label>
            <input class="form-control mb-1" placeholder="提取码" id="url_code"/>
            <label for="map_category">类型</label>
            <input class="form-control mb-1" placeholder="类型" id="map_category">
        </div>
        <div class="d-flex justify-content-center mb-5">
            <button class="btn btn-danger mx-3" onclick="clearInputs()">清空输入框</button>
            <button class="btn btn-primary mx-3" onclick="add()">插入</button>
        </div>
        <div class="" id="table_div"></div>
        <div class="d-flex justify-content-center">
            <button class="btn btn-danger mx-3" onclick="map_info = []; updateTable()">清空表格</button>
            <button class="btn btn-success mx-3" onclick="submit()">提交</button>
        </div>
    </div>
    <script>
        window.onload = function() {
            updateTable();
        }

        const map_name = document.getElementById('map_name');
        const map_url = document.getElementById('map_url');
        const url_code = document.getElementById('url_code');
        const map_category = document.getElementById('map_category');

        let map_info = [];

        function clearInputs() {
            map_name.value = '';
            map_url.value = '';
            url_code.value = '';
            map_category.value = '';
        }

        function add() {
            // 检查是否有空地输入框
            if (map_name.value === '' || map_url.value === '' || url_code.value === '' || map_category.value === '') {
                alert('输入框不能为空');
                return;
            }

            // 检查是否有重复的地图名称
            for (let i = 0; i < map_info.length; i++) {
                if (map_info[i].map_name === map_name.value) {
                    alert('地图名称重复');
                    return;
                }
            }

            // 如果没有重复的名称，那么添加新的地图信息
            map_info.push({
                map_name: map_name.value,
                map_url: map_url.value,
                url_code: url_code.value,
                map_category: map_category.value
            });

            updateTable();
        }

        function updateTable() {
            const table_div = document.getElementById('table_div');
            const table = document.createElement('table');
            table.className = 'table table-striped table-bordered table-hover table-responsive-md';

            const thead = document.createElement('thead');
            const headers = ['地图名称', '地图链接', '提取码', '类型', '操作'];
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            map_info.forEach((info, index) => {
                const row = createRow(info, index);
                table.appendChild(row);
            });

            table_div.innerHTML = '';
            table_div.appendChild(table);
        }

        function createRow(info, index) {
            const row = document.createElement('tr');

            for (let key in info) {
                const cell = document.createElement('td');
                cell.textContent = info[key];
                cell.className = 'break-all'; // 添加这行
                row.appendChild(cell);
            }

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.className = 'btn btn-danger';
            deleteButton.addEventListener('click', function() {
                map_info.splice(index, 1);
                updateTable();
            });

            const cell = document.createElement('td');
            cell.appendChild(deleteButton);
            row.appendChild(cell);

            return row;
        }

        function submit() {
            // 检查 map_info 数组是否为空
            if (map_info.length === 0) {
                alert('表格为空，无法提交');
                return;
            }

            // 将 map_info 数组转换为一个数组，数组的每个元素都是一个对象
            const map_info_arr = map_info.map(info => {
                let obj = {};
                obj[info.map_name] = {
                    url: info.map_url,
                    code: info.url_code,
                    category: info.map_category
                };
                return obj;
            });

            fetch('http://127.0.0.1:5000/save_map_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(map_info_arr)  // 使用转换后的数组
            }).then(response => {
                if (!response.ok) {
                    // 如果服务器返回一个错误状态码，抛出一个错误
                    throw response;
                }
                console.log('Success:', response);
                alert('提交成功');
            }).catch((error) => {
                // 捕获错误，显示服务器返回的错误消息
                error.json().then(errorMessage => {
                    console.error('Error:', errorMessage);
                    alert('提交失败: ' + errorMessage.message + JSON.stringify(errorMessage.duplicate));
                });
            });
        }
    </script>
</body>
</html>